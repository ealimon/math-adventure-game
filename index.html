<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Adventure Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    <style>
        /* Custom font and basic styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffe4e6; /* Pale Pink background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: transparent;
            opacity: 0;
            border-radius: 50%;
            pointer-events: none; /* Allows clicks to pass through */
        }
    </style>
</head>
<body>
    <div id="game-container" class="max-w-xl w-full p-6 sm:p-10 bg-white shadow-2xl rounded-3xl text-center flex flex-col items-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2">
            Math Adventure!
        </h1>
        
        <!-- Game Status Row -->
        <div class="flex justify-between w-full max-w-sm mx-auto text-lg sm:text-xl font-bold mb-6 mt-4">
            <div id="level-badge" class="bg-yellow-400 text-indigo-800 px-4 py-2 rounded-full shadow-md">
                Level 1
            </div>
            <div id="score-display" class="bg-green-400 text-white px-4 py-2 rounded-full shadow-md">
                Score: 0
            </div>
        </div>

        <!-- Problem Display Area -->
        <div id="problem-area" class="w-full">
            <div id="math-problem" class="text-6xl sm:text-8xl font-black text-indigo-900 my-8 sm:my-12 transition duration-300">
                <!-- 2 + 3 = ? -->
            </div>
            <div id="feedback-message" class="h-8 text-2xl font-bold mb-6 text-pink-600">
                <!-- Feedback messages appear here -->
            </div>
        </div>

        <!-- Answer Buttons -->
        <div id="answer-buttons-container" class="grid grid-cols-3 gap-4 w-full max-w-lg">
            <!-- Buttons generated by JavaScript -->
        </div>
        
        <!-- Hidden Overlay for Level Up -->
        <div id="level-up-overlay" class="absolute inset-0 bg-indigo-500 bg-opacity-95 hidden flex flex-col justify-center items-center rounded-3xl p-8 z-10" style="backdrop-filter: blur(5px);">
            <h2 class="text-6xl font-black text-yellow-300 animate-pulse">LEVEL UP!</h2>
            <p id="level-up-message" class="text-3xl font-bold text-white mt-4 mb-8">You reached Level 2!</p>
            <button id="next-level-button" class="bg-green-500 hover:bg-green-600 text-white text-3xl font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-300">
                Start Next Level
            </button>
        </div>
    </div>

    <!-- JavaScript Game Logic and Sound Effects -->
    <script>
        // --- Game State Variables ---
        let currentProblem = { num1: 0, num2: 0, operator: '+', answer: 0 };
        let score = 0;
        let currentLevel = 1;
        let correctCount = 0;
        const targetCount = 10;
        const maxLevel = 4; // Define the current maximum level

        // --- DOM Elements ---
        const mathProblemEl = document.getElementById('math-problem');
        const feedbackEl = document.getElementById('feedback-message');
        const buttonsContainer = document.getElementById('answer-buttons-container');
        const scoreDisplayEl = document.getElementById('score-display');
        const levelBadgeEl = document.getElementById('level-badge');
        const levelUpOverlay = document.getElementById('level-up-overlay');
        const levelUpMessage = document.getElementById('level-up-message');
        const nextLevelButton = document.getElementById('next-level-button');
        const gameContainer = document.getElementById('game-container');


        // --- Sound Generation (Tone.js) ---
        // A simple synth for cheerful feedback
        const correctSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "square" },
            envelope: { attack: 0.05, decay: 0.1, sustain: 0.1, release: 0.5 }
        }).toDestination();
        
        // A simple synth for incorrect feedback
        const incorrectSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 0.4 }
        }).toDestination();

        // Function to play a quick, cheerful arpeggio for correct answers
        function playCorrectSound() {
            // Start the audio context first
            Tone.start(); 
            const now = Tone.now();
            // Play a quick, cheerful C major chord arpeggio
            correctSynth.triggerAttackRelease("C5", "8n", now);
            correctSynth.triggerAttackRelease("E5", "8n", now + 0.1);
            correctSynth.triggerAttackRelease("G5", "4n", now + 0.2);
        }

        // Function to play a short, playful "womp" for incorrect answers
        function playIncorrectSound() {
            // Start the audio context first
            Tone.start(); 
            const now = Tone.now();
            // Play a descending tone
            incorrectSynth.triggerAttackRelease("C4", "8n", now);
            incorrectSynth.triggerAttackRelease("A3", "4n", now + 0.1);
        }

        // --- Confetti Generation ---
        function createConfettiPiece(color) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.backgroundColor = color;
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.top = `${Math.random() * 100}%`;
            confetti.style.transform = `scale(${Math.random() * 0.8 + 0.4})`;
            confetti.style.transition = 'none'; // Disable transition for initial setup

            // Set a random size for variation
            const size = Math.floor(Math.random() * 10) + 5; // 5px to 14px
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size}px`;
            
            gameContainer.appendChild(confetti);
            return confetti;
        }

        function launchConfetti() {
            const colors = ['#f43f5e', '#fbbf24', '#34d399', '#6366f1', '#f97316']; // Pink, Yellow, Green, Indigo, Orange
            const pieceCount = 50;

            for (let i = 0; i < pieceCount; i++) {
                const piece = createConfettiPiece(colors[i % colors.length]);

                // Calculate random trajectories (outside the button area)
                const startX = window.innerWidth / 2;
                const startY = window.innerHeight / 2;

                // Move the confetti to the center of the problem area
                piece.style.left = `${startX}px`;
                piece.style.top = `${startY}px`;
                piece.style.opacity = '1';

                // Apply animation after a very short timeout to ensure initial placement is rendered
                setTimeout(() => {
                    const angle = Math.random() * 360; // Random angle
                    const distance = Math.random() * 300 + 100; // Distance between 100px and 400px
                    const endX = startX + distance * Math.cos(angle);
                    const endY = startY + distance * Math.sin(angle) - 150; // Fly upwards

                    piece.style.transition = 'transform 1.5s ease-out, opacity 1s ease-out';
                    piece.style.transform = `translate(${endX - startX}px, ${endY - startY}px) rotate(${Math.random() * 720}deg)`;
                    piece.style.opacity = '0';
                }, 10); // Small delay

                // Clean up the DOM after the animation
                setTimeout(() => {
                    piece.remove();
                }, 1600);
            }
        }


        // --- Game Logic ---

        function getLevelConfig(level) {
            // Determines max numbers and operations based on the current level
            switch (level) {
                case 1: // Focus on small addition
                    return { maxNum: 5, operator: '+' };
                case 2: // Increase addition range
                    return { maxNum: 10, operator: '+' };
                case 3: // Introduce small subtraction
                    return { maxNum: 10, operator: '+-' };
                case 4: // Increase number range for mixed operations
                    return { maxNum: 15, operator: '+-' };
                default: // Max level reached, maintain difficulty
                    return { maxNum: 15, operator: '+-' };
            }
        }

        function generateProblem() {
            const config = getLevelConfig(currentLevel);
            let num1, num2, operator, answer;

            // Select operator
            if (config.operator === '+') {
                operator = '+';
            } else if (config.operator === '+-') {
                operator = Math.random() < 0.5 ? '+' : '-';
            } else {
                operator = '+'; // Default to addition
            }

            // Generate numbers based on operator and maxNum
            if (operator === '+') {
                num1 = Math.floor(Math.random() * config.maxNum) + 1;
                num2 = Math.floor(Math.random() * config.maxNum) + 1;
                answer = num1 + num2;
            } else { // Subtraction
                let maxVal = config.maxNum;
                // Ensure the result is non-negative and numbers are appropriate for maxVal
                num1 = Math.floor(Math.random() * maxVal) + 5; // Ensure num1 is large enough
                num2 = Math.floor(Math.random() * (num1 - 1)) + 1; // Ensure num2 < num1
                answer = num1 - num2;
            }

            currentProblem = { num1, num2, operator, answer };
            mathProblemEl.textContent = `${num1} ${operator} ${num2} = ?`;

            generateAnswerOptions(answer);
        }

        function generateAnswerOptions(correctAnswer) {
            const options = new Set();
            options.add(correctAnswer);

            while (options.size < 3) {
                // Generate a close, distracting incorrect answer
                let incorrectAnswer = correctAnswer + Math.floor(Math.random() * 5) * (Math.random() < 0.5 ? 1 : -1);

                // Ensure answer is non-negative and not the correct answer
                if (incorrectAnswer >= 0 && incorrectAnswer !== correctAnswer) {
                    options.add(incorrectAnswer);
                }
            }

            const optionsArray = Array.from(options);
            // Shuffle the array to randomize button placement
            optionsArray.sort(() => Math.random() - 0.5);

            renderButtons(optionsArray);
        }

        function renderButtons(options) {
            buttonsContainer.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'answer-button bg-pink-500 hover:bg-pink-600 text-white text-3xl sm:text-4xl font-bold py-4 rounded-xl shadow-lg transform hover:scale-105 transition duration-300';
                button.setAttribute('data-answer', option);
                button.addEventListener('click', handleAnswerClick);
                buttonsContainer.appendChild(button);
            });
        }

        function updateScore(isCorrect) {
            if (isCorrect) {
                score++;
                correctCount++;
                scoreDisplayEl.textContent = `Score: ${score}`;

                if (correctCount >= targetCount) {
                    showLevelUpScreen();
                }
            }
        }

        function handleAnswerClick(event) {
            const selectedAnswer = parseInt(event.target.getAttribute('data-answer'));
            const isCorrect = selectedAnswer === currentProblem.answer;

            // Temporarily disable buttons
            document.querySelectorAll('.answer-button').forEach(btn => btn.disabled = true);

            if (isCorrect) {
                // Visual and audio feedback for correct answer
                event.target.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                event.target.classList.add('bg-green-500');
                feedbackEl.textContent = "Correct! 🎉";
                feedbackEl.classList.remove('text-pink-600');
                feedbackEl.classList.add('text-green-600');
                
                playCorrectSound();
                launchConfetti();
                updateScore(true);

                // Delay for visual feedback before generating the next problem
                setTimeout(() => {
                    feedbackEl.textContent = "";
                    feedbackEl.classList.remove('text-green-600');
                    feedbackEl.classList.add('text-pink-600');
                    if (correctCount < targetCount) {
                        generateProblem();
                        // Re-enable buttons by rendering the next set
                    }
                }, 1500);

            } else {
                // Visual and audio feedback for incorrect answer
                event.target.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                event.target.classList.add('bg-red-500');
                feedbackEl.textContent = "Oops! Try again.";
                feedbackEl.classList.remove('text-pink-600');
                feedbackEl.classList.add('text-red-600');

                playIncorrectSound();
                updateScore(false);

                // Re-enable buttons immediately after visual cue
                setTimeout(() => {
                    feedbackEl.textContent = "";
                    feedbackEl.classList.remove('text-red-600');
                    feedbackEl.classList.add('text-pink-600');
                    // Re-enable the buttons if the level up screen is not shown
                    if (correctCount < targetCount) {
                         document.querySelectorAll('.answer-button').forEach(btn => btn.disabled = false);
                    }
                    // Reset the color of the incorrect button
                    event.target.classList.remove('bg-red-500');
                    event.target.classList.add('bg-pink-500', 'hover:bg-pink-600');

                }, 1500);
            }
        }

        function showLevelUpScreen() {
            if (currentLevel < maxLevel) {
                levelUpMessage.textContent = `You mastered Level ${currentLevel}! Prepare for Level ${currentLevel + 1}!`;
            } else {
                levelUpMessage.textContent = `You reached the highest level! Great job!`;
                nextLevelButton.textContent = "Keep Practicing";
            }
            
            levelUpOverlay.classList.remove('hidden');
            // Disable buttons beneath the overlay
            buttonsContainer.style.pointerEvents = 'none';
        }

        function advanceLevel() {
            // Hide the overlay
            levelUpOverlay.classList.add('hidden');
            buttonsContainer.style.pointerEvents = 'auto';

            // Check if we can still advance
            if (currentLevel < maxLevel) {
                currentLevel++;
            }
            
            correctCount = 0; // Reset correct count for the new level
            levelBadgeEl.textContent = `Level ${currentLevel}`;
            
            // Start the next level
            generateProblem();
        }

        // --- Initialization ---
        function init() {
            generateProblem();
            nextLevelButton.addEventListener('click', advanceLevel);
        }

        // Initialize the game when the window loads
        window.onload = init;

    </script>
</body>
</html>
